
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Package for processing polarised images to measure stress in granular media">
      
      
        <meta name="author" content="Benjy Marks, Qianyu Fang">
      
      
        <link rel="canonical" href="https://benjym.github.io/photoelastimetry/reference/equilibrium_solver/">
      
      
        <link rel="prev" href="../intensity_solver/">
      
      
        <link rel="next" href="../../contributing/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>equilibrium_solver - Photoelastimetry</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#solverequilibrium_solver" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Photoelastimetry" class="md-header__button md-logo" aria-label="Photoelastimetry" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Photoelastimetry
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              equilibrium_solver
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/benjym/photoelastimetry" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    benjym/photoelastimetry
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../getting-started/" class="md-tabs__link">
        
  
  
    
  
  Getting Started

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../user-guide/" class="md-tabs__link">
        
  
  
    
  
  User Guide

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../examples/" class="md-tabs__link">
        
  
  
    
  
  Examples

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../contributing/" class="md-tabs__link">
        
  
  
    
  
  Contributing

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Photoelastimetry" class="md-nav__button md-logo" aria-label="Photoelastimetry" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Photoelastimetry
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/benjym/photoelastimetry" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    benjym/photoelastimetry
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    User Guide
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Core Modules
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Core Modules
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../disk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    disk
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../image/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    image
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../io/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    io
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../main/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    main
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plotting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    plotting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" checked>
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Solver Modules
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Solver Modules
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../solver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    solver
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stokes_solver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    stokes_solver
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../intensity_solver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    intensity_solver
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    equilibrium_solver
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    equilibrium_solver
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#key-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Functions
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;equilibrium_solver
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" equilibrium_solver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver.build_finite_difference_operators" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;build_finite_difference_operators
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver.airy_to_stress" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;airy_to_stress
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver.compute_global_residual" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;compute_global_residual
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver.recover_stress_field_global" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;recover_stress_field_global
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver.recover_stress_field_global_iterative" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;recover_stress_field_global_iterative
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver.compare_local_vs_global" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;compare_local_vs_global
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#key-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Functions
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;equilibrium_solver
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" equilibrium_solver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver.build_finite_difference_operators" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;build_finite_difference_operators
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver.airy_to_stress" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;airy_to_stress
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver.compute_global_residual" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;compute_global_residual
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver.recover_stress_field_global" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;recover_stress_field_global
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver.recover_stress_field_global_iterative" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;recover_stress_field_global_iterative
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#photoelastimetry.solver.equilibrium_solver.compare_local_vs_global" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;compare_local_vs_global
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="solverequilibrium_solver">solver.equilibrium_solver<a class="headerlink" href="#solverequilibrium_solver" title="Permanent link">&para;</a></h1>
<p>Global equilibrium-based stress inversion.</p>
<p>This module implements a global stress field recovery method that enforces mechanical equilibrium constraints using an Airy stress function representation. This approach ensures the recovered stress field satisfies equilibrium equations.</p>
<h2 id="key-functions">Key Functions<a class="headerlink" href="#key-functions" title="Permanent link">&para;</a></h2>
<ul>
<li><code>build_finite_difference_operators()</code> - Construct finite difference matrices</li>
<li><code>airy_to_stress()</code> - Convert Airy function to stress components</li>
<li><code>recover_stress_field_global()</code> - Main function for equilibrium-based recovery</li>
<li><code>compare_local_vs_global()</code> - Compare pixel-wise vs equilibrium methods</li>
</ul>


<div class="doc doc-object doc-module">



<h2 id="photoelastimetry.solver.equilibrium_solver" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>equilibrium_solver</code>


<a href="#photoelastimetry.solver.equilibrium_solver" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">

        <p>Global stress measurement using Airy stress function.</p>
<p>This module implements a global inversion approach that solves for an Airy stress
function across the entire domain simultaneously. Unlike the local pixel-by-pixel
method, this approach:</p>
<ol>
<li>Ensures mechanical equilibrium by construction (through Airy stress function)</li>
<li>Enforces smoothness globally via regularization</li>
<li>Avoids local minima by solving a single global optimization problem</li>
<li>Provides more stable results by incorporating spatial coupling</li>
</ol>
<p>The Airy stress function φ(x,y) relates to stresses via:
    σ_xx = ∂²φ/∂y²
    σ_yy = ∂²φ/∂x²
    σ_xy = -∂²φ/∂x∂y</p>
<p>These automatically satisfy equilibrium: ∂σ_xx/∂x + ∂σ_xy/∂y = 0 and
∂σ_xy/∂x + ∂σ_yy/∂y = 0.</p>










  <div class="doc doc-children">








<h3 id="photoelastimetry.solver.equilibrium_solver-functions">Functions<a href="#photoelastimetry.solver.equilibrium_solver-functions" class="headerlink" title="Permanent link">&para;</a></h3>

<div class="doc doc-object doc-function">


<h4 id="photoelastimetry.solver.equilibrium_solver.build_finite_difference_operators" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">build_finite_difference_operators</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

<a href="#photoelastimetry.solver.equilibrium_solver.build_finite_difference_operators" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Build sparse finite difference operators for computing derivatives.</p>
<p>Uses central differences for interior points and forward/backward
differences at boundaries.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>nx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of grid points in x direction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ny</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of grid points in y direction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dx</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Grid spacing in x direction (default: 1.0).</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dy</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Grid spacing in y direction (default: 1.0).</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>D2x</code></td>            <td>
                  <code>scipy.sparse matrix</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second derivative operator in x direction (∂²/∂x²).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>D2y</code></td>            <td>
                  <code>scipy.sparse matrix</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second derivative operator in y direction (∂²/∂y²).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>Dxy</code></td>            <td>
                  <code>scipy.sparse matrix</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mixed derivative operator (∂²/∂x∂y).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>L</code></td>            <td>
                  <code>scipy.sparse matrix</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Laplacian operator (∇²).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>photoelastimetry/solver/equilibrium_solver.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_finite_difference_operators</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">    Build sparse finite difference operators for computing derivatives.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">    Uses central differences for interior points and forward/backward</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    differences at boundaries.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    nx : int</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        Number of grid points in x direction.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    ny : int</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        Number of grid points in y direction.</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">    dx : float, optional</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        Grid spacing in x direction (default: 1.0).</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">    dy : float, optional</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        Grid spacing in y direction (default: 1.0).</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">    -------</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    D2x : scipy.sparse matrix</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">        Second derivative operator in x direction (∂²/∂x²).</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">    D2y : scipy.sparse matrix</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">        Second derivative operator in y direction (∂²/∂y²).</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    Dxy : scipy.sparse matrix</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">        Mixed derivative operator (∂²/∂x∂y).</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">    L : scipy.sparse matrix</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">        Laplacian operator (∇²).</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">diags</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">eye</span> <span class="k">as</span> <span class="n">speye</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">kron</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="c1"># 1D second derivative operator (central differences)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="c1"># [1, -2, 1] / dx^2</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">diag_1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">offsets_1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="c1"># Build 1D operators</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="n">D2_1d_x</span> <span class="o">=</span> <span class="n">diags</span><span class="p">(</span><span class="n">diag_1d</span><span class="p">,</span> <span class="n">offsets_1d</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">))</span> <span class="o">/</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="n">D2_1d_y</span> <span class="o">=</span> <span class="n">diags</span><span class="p">(</span><span class="n">diag_1d</span><span class="p">,</span> <span class="n">offsets_1d</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span> <span class="o">/</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="c1"># 2D operators using Kronecker products</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="c1"># For a field organized as [φ(0,0), φ(1,0), ..., φ(nx-1,0), φ(0,1), ...]</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">I_x</span> <span class="o">=</span> <span class="n">speye</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">I_y</span> <span class="o">=</span> <span class="n">speye</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="c1"># ∂²/∂x² operator</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="n">D2x</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">I_y</span><span class="p">,</span> <span class="n">D2_1d_x</span><span class="p">)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="c1"># ∂²/∂y² operator</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="n">D2y</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">D2_1d_y</span><span class="p">,</span> <span class="n">I_x</span><span class="p">)</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="c1"># Mixed derivative ∂²/∂x∂y</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="c1"># First derivative operators</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>    <span class="n">diag_d1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="n">offsets_d1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="n">Dx_1d</span> <span class="o">=</span> <span class="n">diags</span><span class="p">(</span><span class="n">diag_d1</span><span class="p">,</span> <span class="n">offsets_d1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">))</span> <span class="o">/</span> <span class="n">dx</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="n">Dy_1d</span> <span class="o">=</span> <span class="n">diags</span><span class="p">(</span><span class="n">diag_d1</span><span class="p">,</span> <span class="n">offsets_d1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span> <span class="o">/</span> <span class="n">dy</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="n">Dx</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">I_y</span><span class="p">,</span> <span class="n">Dx_1d</span><span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="n">Dy</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">Dy_1d</span><span class="p">,</span> <span class="n">I_x</span><span class="p">)</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="c1"># Mixed derivative: ∂/∂x(∂/∂y)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">Dxy</span> <span class="o">=</span> <span class="n">Dx</span> <span class="o">@</span> <span class="n">Dy</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="c1"># Laplacian (for regularization)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="n">L</span> <span class="o">=</span> <span class="n">D2x</span> <span class="o">+</span> <span class="n">D2y</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="k">return</span> <span class="n">D2x</span><span class="p">,</span> <span class="n">D2y</span><span class="p">,</span> <span class="n">Dxy</span><span class="p">,</span> <span class="n">L</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="photoelastimetry.solver.equilibrium_solver.airy_to_stress" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">airy_to_stress</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">D2x</span><span class="p">,</span> <span class="n">D2y</span><span class="p">,</span> <span class="n">Dxy</span><span class="p">)</span></code>

<a href="#photoelastimetry.solver.equilibrium_solver.airy_to_stress" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Convert Airy stress function to stress components.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>phi</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Airy stress function values on grid (flattened or 2D).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>D2x</code>
            </td>
            <td>
                  <code>scipy.sparse matrix</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second derivative operator in x direction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>D2y</code>
            </td>
            <td>
                  <code>scipy.sparse matrix</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second derivative operator in y direction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Dxy</code>
            </td>
            <td>
                  <code>scipy.sparse matrix</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mixed derivative operator.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>sigma_xx</code></td>            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Normal stress in x direction (same shape as phi).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>sigma_yy</code></td>            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Normal stress in y direction (same shape as phi).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>sigma_xy</code></td>            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shear stress (same shape as phi).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>photoelastimetry/solver/equilibrium_solver.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="k">def</span><span class="w"> </span><span class="nf">airy_to_stress</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">D2x</span><span class="p">,</span> <span class="n">D2y</span><span class="p">,</span> <span class="n">Dxy</span><span class="p">):</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">    Convert Airy stress function to stress components.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">    phi : ndarray</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">        Airy stress function values on grid (flattened or 2D).</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">    D2x : scipy.sparse matrix</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">        Second derivative operator in x direction.</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">    D2y : scipy.sparse matrix</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">        Second derivative operator in y direction.</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">    Dxy : scipy.sparse matrix</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">        Mixed derivative operator.</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">    -------</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">    sigma_xx : ndarray</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">        Normal stress in x direction (same shape as phi).</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">    sigma_yy : ndarray</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">        Normal stress in y direction (same shape as phi).</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">    sigma_xy : ndarray</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">        Shear stress (same shape as phi).</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="n">phi_flat</span> <span class="o">=</span> <span class="n">phi</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="c1"># σ_xx = ∂²φ/∂y²</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="n">sigma_xx</span> <span class="o">=</span> <span class="n">D2y</span> <span class="o">@</span> <span class="n">phi_flat</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="c1"># σ_yy = ∂²φ/∂x²</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="n">sigma_yy</span> <span class="o">=</span> <span class="n">D2x</span> <span class="o">@</span> <span class="n">phi_flat</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="c1"># σ_xy = -∂²φ/∂x∂y</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="n">sigma_xy</span> <span class="o">=</span> <span class="o">-</span><span class="n">Dxy</span> <span class="o">@</span> <span class="n">phi_flat</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="k">return</span> <span class="n">sigma_xx</span><span class="p">,</span> <span class="n">sigma_yy</span><span class="p">,</span> <span class="n">sigma_xy</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="photoelastimetry.solver.equilibrium_solver.compute_global_residual" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">compute_global_residual</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">image_stack</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="n">C_values</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">S_i_hat</span><span class="p">,</span> <span class="n">D2x</span><span class="p">,</span> <span class="n">D2y</span><span class="p">,</span> <span class="n">Dxy</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">lambda_smooth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">lambda_biharmonic</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>

<a href="#photoelastimetry.solver.equilibrium_solver.compute_global_residual" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Compute global residual for Airy stress function optimization.</p>
<p>This function computes the misfit between measured and predicted Stokes
parameters across all pixels and wavelengths, plus regularization terms.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>phi</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Airy stress function values (flattened).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>image_stack</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Image stack [H, W, 3, 4] with RGB channels and 4 polarization angles.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>wavelengths</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Wavelengths for RGB channels (m).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>C_values</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stress-optic coefficients for RGB channels (1/Pa).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nu</code>
            </td>
            <td>
                  <code><span title="float">float</span> or <span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solid fraction (use 1.0 for solid samples).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>L</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sample thickness (m).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>S_i_hat</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Incoming normalized Stokes vector [S1_hat, S2_hat] or [S1_hat, S2_hat, S3_hat].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>D2x</code>
            </td>
            <td>
                  <code>scipy.sparse matrix</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Finite difference operators.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>D2y</code>
            </td>
            <td>
                  <code>scipy.sparse matrix</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Finite difference operators.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Dxy</code>
            </td>
            <td>
                  <code>scipy.sparse matrix</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Finite difference operators.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Boolean mask indicating valid pixels (H, W).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lambda_smooth</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Regularization weight for Laplacian smoothing (default: 1.0).</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lambda_biharmonic</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Regularization weight for biharmonic smoothing (default: 0.0).</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>residual</code></td>            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total residual including data misfit and regularization terms.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>photoelastimetry/solver/equilibrium_solver.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_global_residual</span><span class="p">(</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="n">phi</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">image_stack</span><span class="p">,</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="n">wavelengths</span><span class="p">,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="n">C_values</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="n">nu</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="n">L</span><span class="p">,</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="n">S_i_hat</span><span class="p">,</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="n">D2x</span><span class="p">,</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="n">D2y</span><span class="p">,</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="n">Dxy</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="n">mask</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="n">lambda_smooth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="n">lambda_biharmonic</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="p">):</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">    Compute global residual for Airy stress function optimization.</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">    This function computes the misfit between measured and predicted Stokes</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">    parameters across all pixels and wavelengths, plus regularization terms.</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">    phi : ndarray</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">        Airy stress function values (flattened).</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">    image_stack : ndarray</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        Image stack [H, W, 3, 4] with RGB channels and 4 polarization angles.</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">    wavelengths : array-like</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">        Wavelengths for RGB channels (m).</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">    C_values : array-like</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">        Stress-optic coefficients for RGB channels (1/Pa).</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">    nu : float or ndarray</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">        Solid fraction (use 1.0 for solid samples).</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">    L : float</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">        Sample thickness (m).</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">    S_i_hat : array-like</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">        Incoming normalized Stokes vector [S1_hat, S2_hat] or [S1_hat, S2_hat, S3_hat].</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">    D2x, D2y, Dxy : scipy.sparse matrix</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">        Finite difference operators.</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">    mask : ndarray</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">        Boolean mask indicating valid pixels (H, W).</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">    lambda_smooth : float, optional</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">        Regularization weight for Laplacian smoothing (default: 1.0).</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">    lambda_biharmonic : float, optional</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">        Regularization weight for biharmonic smoothing (default: 0.0).</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">    -------</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">    residual : float</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">        Total residual including data misfit and regularization terms.</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>    <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">image_stack</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="c1"># Convert Airy function to stresses</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="n">sigma_xx</span><span class="p">,</span> <span class="n">sigma_yy</span><span class="p">,</span> <span class="n">sigma_xy</span> <span class="o">=</span> <span class="n">airy_to_stress</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">D2x</span><span class="p">,</span> <span class="n">D2y</span><span class="p">,</span> <span class="n">Dxy</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="c1"># Reshape to 2D</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="n">sigma_xx</span> <span class="o">=</span> <span class="n">sigma_xx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="n">sigma_yy</span> <span class="o">=</span> <span class="n">sigma_yy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="n">sigma_xy</span> <span class="o">=</span> <span class="n">sigma_xy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="c1"># Data misfit term</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="n">data_residual</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="n">n_valid</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">H</span><span class="p">):</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">W</span><span class="p">):</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                <span class="k">continue</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="c1"># Get measured Stokes components for this pixel</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="n">S_m_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="n">valid_pixel</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>  <span class="c1"># RGB channels</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                <span class="n">I</span> <span class="o">=</span> <span class="n">image_stack</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                    <span class="n">valid_pixel</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                    <span class="k">break</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                <span class="n">S0</span><span class="p">,</span> <span class="n">S1</span><span class="p">,</span> <span class="n">S2</span> <span class="o">=</span> <span class="n">stokes_solver</span><span class="o">.</span><span class="n">compute_stokes_components</span><span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                <span class="n">S1_hat</span><span class="p">,</span> <span class="n">S2_hat</span> <span class="o">=</span> <span class="n">stokes_solver</span><span class="o">.</span><span class="n">compute_normalized_stokes</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">S1</span><span class="p">,</span> <span class="n">S2</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                <span class="n">S_m_hat</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">S1_hat</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                <span class="n">S_m_hat</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S2_hat</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_pixel</span><span class="p">:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                <span class="k">continue</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="c1"># Get solid fraction for this pixel</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="n">nu_pixel</span> <span class="o">=</span> <span class="n">nu</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span> <span class="k">else</span> <span class="n">nu</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="c1"># Predict Stokes components from stress</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                <span class="n">S_p_hat</span> <span class="o">=</span> <span class="n">stokes_solver</span><span class="o">.</span><span class="n">predict_stokes</span><span class="p">(</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                    <span class="n">sigma_xx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                    <span class="n">sigma_yy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>                    <span class="n">sigma_xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                    <span class="n">C_values</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                    <span class="n">nu_pixel</span><span class="p">,</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                    <span class="n">L</span><span class="p">,</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                    <span class="n">wavelengths</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                    <span class="n">S_i_hat</span><span class="p">,</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                <span class="p">)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                <span class="n">diff</span> <span class="o">=</span> <span class="n">S_m_hat</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">S_p_hat</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                <span class="n">data_residual</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">diff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="n">n_valid</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>    <span class="c1"># Normalize by number of valid pixels</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>    <span class="k">if</span> <span class="n">n_valid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="n">data_residual</span> <span class="o">/=</span> <span class="n">n_valid</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>    <span class="c1"># Smoothness regularization (Laplacian)</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>    <span class="n">smoothness_residual</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>    <span class="k">if</span> <span class="n">lambda_smooth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="c1"># Build Laplacian operator</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="n">L_op</span> <span class="o">=</span> <span class="n">D2x</span> <span class="o">+</span> <span class="n">D2y</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="n">lap_phi</span> <span class="o">=</span> <span class="n">L_op</span> <span class="o">@</span> <span class="n">phi</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="n">smoothness_residual</span> <span class="o">=</span> <span class="n">lambda_smooth</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lap_phi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>    <span class="c1"># Biharmonic regularization (∇⁴φ)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>    <span class="n">biharmonic_residual</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>    <span class="k">if</span> <span class="n">lambda_biharmonic</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="n">L_op</span> <span class="o">=</span> <span class="n">D2x</span> <span class="o">+</span> <span class="n">D2y</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="n">biharm_phi</span> <span class="o">=</span> <span class="n">L_op</span> <span class="o">@</span> <span class="p">(</span><span class="n">L_op</span> <span class="o">@</span> <span class="n">phi</span><span class="p">)</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="n">biharmonic_residual</span> <span class="o">=</span> <span class="n">lambda_biharmonic</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">biharm_phi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="n">total_residual</span> <span class="o">=</span> <span class="n">data_residual</span> <span class="o">+</span> <span class="n">smoothness_residual</span> <span class="o">+</span> <span class="n">biharmonic_residual</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>    <span class="k">return</span> <span class="n">total_residual</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="photoelastimetry.solver.equilibrium_solver.recover_stress_field_global" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">recover_stress_field_global</span><span class="p">(</span><span class="n">image_stack</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="n">C_values</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">S_i_hat</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">lambda_smooth</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">,</span> <span class="n">lambda_biharmonic</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">initial_phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#photoelastimetry.solver.equilibrium_solver.recover_stress_field_global" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Recover stress field globally using Airy stress function.</p>
<p>This is the main function for global stress field reconstruction. It sets up
the optimization problem and solves for the Airy stress function that best
fits the measured polarimetric data while enforcing smoothness.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image_stack</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Image stack [H, W, 3, 4] with RGB channels and 4 polarization angles.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>wavelengths</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Wavelengths for RGB channels (m).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>C_values</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stress-optic coefficients for RGB channels (1/Pa).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nu</code>
            </td>
            <td>
                  <code><span title="float">float</span> or <span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solid fraction (use 1.0 for solid samples).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>L</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sample thickness (m).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>S_i_hat</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Incoming normalized Stokes vector [S1_hat, S2_hat, S3_hat].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Boolean mask indicating valid pixels [H, W]. If None, all pixels are used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dx</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Grid spacing in x direction (default: 1.0).</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dy</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Grid spacing in y direction (default: 1.0).</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lambda_smooth</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Regularization weight for Laplacian smoothing (default: 1e-6).
Higher values enforce smoother solutions.</p>
              </div>
            </td>
            <td>
                  <code>1e-06</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lambda_biharmonic</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Regularization weight for biharmonic smoothing (default: 0.0).
Enforces even smoother solutions but can be expensive.</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>initial_phi</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial guess for Airy function [H, W]. If None, uses results from
local solver as initialization.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>maxiter</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of optimization iterations (default: 1000).</p>
              </div>
            </td>
            <td>
                  <code>1000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>method</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optimization method (default: 'L-BFGS-B'). Options: 'L-BFGS-B', 'CG',
'Newton-CG', 'trust-ncg'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;L-BFGS-B&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print progress information (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>phi</code></td>            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Airy stress function [H, W].</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>stress_field</code></td>            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stress components [H, W, 3] = [σ_xx, σ_yy, σ_xy].</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>result</code></td>            <td>
                  <code><span title="scipy.optimize.OptimizeResult">OptimizeResult</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optimization result object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The optimization minimizes:
    E = E_data + λ_smooth * E_smooth + λ_biharm * E_biharm</p>
<p>where:
- E_data is the misfit between measured and predicted Stokes parameters
- E_smooth is the Laplacian penalty (∇²φ)²
- E_biharm is the biharmonic penalty (∇⁴φ)²</p>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="p">,</span> <span class="n">stress</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">recover_stress_field_global</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">image_stack</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="n">C_values</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">S_i_hat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="n">lambda_smooth</span><span class="o">=</span><span class="mf">1e-5</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>photoelastimetry/solver/equilibrium_solver.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="k">def</span><span class="w"> </span><span class="nf">recover_stress_field_global</span><span class="p">(</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>    <span class="n">image_stack</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>    <span class="n">wavelengths</span><span class="p">,</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="n">C_values</span><span class="p">,</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>    <span class="n">nu</span><span class="p">,</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="n">L</span><span class="p">,</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>    <span class="n">S_i_hat</span><span class="p">,</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>    <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>    <span class="n">dy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="n">lambda_smooth</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>    <span class="n">lambda_biharmonic</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>    <span class="n">initial_phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="n">maxiter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="p">):</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">    Recover stress field globally using Airy stress function.</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">    This is the main function for global stress field reconstruction. It sets up</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a><span class="sd">    the optimization problem and solves for the Airy stress function that best</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a><span class="sd">    fits the measured polarimetric data while enforcing smoothness.</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">    image_stack : ndarray</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">        Image stack [H, W, 3, 4] with RGB channels and 4 polarization angles.</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">    wavelengths : array-like</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">        Wavelengths for RGB channels (m).</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">    C_values : array-like</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="sd">        Stress-optic coefficients for RGB channels (1/Pa).</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">    nu : float or ndarray</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="sd">        Solid fraction (use 1.0 for solid samples).</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="sd">    L : float</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="sd">        Sample thickness (m).</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">    S_i_hat : array-like</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">        Incoming normalized Stokes vector [S1_hat, S2_hat, S3_hat].</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">    mask : ndarray, optional</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a><span class="sd">        Boolean mask indicating valid pixels [H, W]. If None, all pixels are used.</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">    dx : float, optional</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="sd">        Grid spacing in x direction (default: 1.0).</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="sd">    dy : float, optional</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><span class="sd">        Grid spacing in y direction (default: 1.0).</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="sd">    lambda_smooth : float, optional</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="sd">        Regularization weight for Laplacian smoothing (default: 1e-6).</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">        Higher values enforce smoother solutions.</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a><span class="sd">    lambda_biharmonic : float, optional</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="sd">        Regularization weight for biharmonic smoothing (default: 0.0).</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="sd">        Enforces even smoother solutions but can be expensive.</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="sd">    initial_phi : ndarray, optional</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="sd">        Initial guess for Airy function [H, W]. If None, uses results from</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="sd">        local solver as initialization.</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a><span class="sd">    maxiter : int, optional</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a><span class="sd">        Maximum number of optimization iterations (default: 1000).</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="sd">    method : str, optional</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a><span class="sd">        Optimization method (default: &#39;L-BFGS-B&#39;). Options: &#39;L-BFGS-B&#39;, &#39;CG&#39;,</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a><span class="sd">        &#39;Newton-CG&#39;, &#39;trust-ncg&#39;.</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="sd">    verbose : bool, optional</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="sd">        Print progress information (default: True).</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="sd">    -------</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><span class="sd">    phi : ndarray</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="sd">        Airy stress function [H, W].</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="sd">    stress_field : ndarray</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="sd">        Stress components [H, W, 3] = [σ_xx, σ_yy, σ_xy].</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="sd">    result : scipy.optimize.OptimizeResult</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a><span class="sd">        Optimization result object.</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="sd">    -----</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a><span class="sd">    The optimization minimizes:</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="sd">        E = E_data + λ_smooth * E_smooth + λ_biharm * E_biharm</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a><span class="sd">    where:</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="sd">    - E_data is the misfit between measured and predicted Stokes parameters</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><span class="sd">    - E_smooth is the Laplacian penalty (∇²φ)²</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a><span class="sd">    - E_biharm is the biharmonic penalty (∇⁴φ)²</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">    Examples</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a><span class="sd">    --------</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">    &gt;&gt;&gt; phi, stress, result = recover_stress_field_global(</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">    ...     image_stack, wavelengths, C_values, nu=1.0, L=0.01,</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">    ...     S_i_hat=np.array([1.0, 0.0, 0.0]), lambda_smooth=1e-5</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">    ... )</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>    <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">image_stack</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting up global optimization...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid size: </span><span class="si">{</span><span class="n">H</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">W</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">H</span><span class="o">*</span><span class="n">W</span><span class="si">}</span><span class="s2"> points&quot;</span><span class="p">)</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Regularization: λ_smooth = </span><span class="si">{</span><span class="n">lambda_smooth</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, λ_biharm = </span><span class="si">{</span><span class="n">lambda_biharmonic</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>    <span class="c1"># Build finite difference operators</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>    <span class="n">D2x</span><span class="p">,</span> <span class="n">D2y</span><span class="p">,</span> <span class="n">Dxy</span><span class="p">,</span> <span class="n">L_op</span> <span class="o">=</span> <span class="n">build_finite_difference_operators</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>    <span class="c1"># Initialize Airy function</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>    <span class="k">if</span> <span class="n">initial_phi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing initial guess from local solver...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>        <span class="c1"># Use local solver for initialization</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">photoelastimetry.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">recover_stress_map</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="n">stress_local</span> <span class="o">=</span> <span class="n">recover_stress_map</span><span class="p">(</span><span class="n">image_stack</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="n">C_values</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">S_i_hat</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>        <span class="c1"># Reconstruct Airy function from local stresses (approximate)</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>        <span class="c1"># This is an approximate inverse - we solve Poisson problems</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>        <span class="n">sigma_xx_local</span> <span class="o">=</span> <span class="n">stress_local</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>        <span class="n">sigma_yy_local</span> <span class="o">=</span> <span class="n">stress_local</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="c1"># φ_yy = σ_xx and φ_xx = σ_yy</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="c1"># Average these two constraints with regularization</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>        <span class="n">A</span> <span class="o">=</span> <span class="n">D2x</span> <span class="o">+</span> <span class="n">D2y</span> <span class="o">+</span> <span class="n">lambda_smooth</span> <span class="o">*</span> <span class="n">L_op</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">L_op</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">D2x</span> <span class="o">@</span> <span class="n">sigma_yy_local</span> <span class="o">+</span> <span class="n">D2y</span> <span class="o">@</span> <span class="n">sigma_xx_local</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>            <span class="n">phi_init</span> <span class="o">=</span> <span class="n">spsolve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>            <span class="c1"># Fallback to zero initialization</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Could not invert for initial Airy function, using zeros&quot;</span><span class="p">)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>            <span class="n">phi_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">W</span><span class="p">)</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="n">phi_init</span> <span class="o">=</span> <span class="n">initial_phi</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting optimization with method &#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>    <span class="c1"># Define callback for progress monitoring</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>    <span class="n">iteration</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">(</span><span class="n">xk</span><span class="p">):</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>        <span class="n">iteration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">iteration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="n">residual</span> <span class="o">=</span> <span class="n">compute_global_residual</span><span class="p">(</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                <span class="n">xk</span><span class="p">,</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                <span class="n">image_stack</span><span class="p">,</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>                <span class="n">wavelengths</span><span class="p">,</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>                <span class="n">C_values</span><span class="p">,</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>                <span class="n">nu</span><span class="p">,</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>                <span class="n">L</span><span class="p">,</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>                <span class="n">S_i_hat</span><span class="p">,</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>                <span class="n">D2x</span><span class="p">,</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>                <span class="n">D2y</span><span class="p">,</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>                <span class="n">Dxy</span><span class="p">,</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>                <span class="n">mask</span><span class="p">,</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>                <span class="n">lambda_smooth</span><span class="p">,</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>                <span class="n">lambda_biharmonic</span><span class="p">,</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>            <span class="p">)</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: residual = </span><span class="si">{</span><span class="n">residual</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>    <span class="c1"># Optimize</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>        <span class="n">compute_global_residual</span><span class="p">,</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>        <span class="n">phi_init</span><span class="p">,</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>        <span class="n">args</span><span class="o">=</span><span class="p">(</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>            <span class="n">image_stack</span><span class="p">,</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>            <span class="n">wavelengths</span><span class="p">,</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>            <span class="n">C_values</span><span class="p">,</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>            <span class="n">nu</span><span class="p">,</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>            <span class="n">L</span><span class="p">,</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>            <span class="n">S_i_hat</span><span class="p">,</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>            <span class="n">D2x</span><span class="p">,</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>            <span class="n">D2y</span><span class="p">,</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>            <span class="n">Dxy</span><span class="p">,</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>            <span class="n">mask</span><span class="p">,</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>            <span class="n">lambda_smooth</span><span class="p">,</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>            <span class="n">lambda_biharmonic</span><span class="p">,</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>        <span class="p">),</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="n">maxiter</span><span class="p">,</span> <span class="s2">&quot;disp&quot;</span><span class="p">:</span> <span class="n">verbose</span><span class="p">},</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>        <span class="n">callback</span><span class="o">=</span><span class="n">callback</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>    <span class="p">)</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optimization completed: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final residual: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">fun</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Success: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>    <span class="c1"># Extract final solution</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>    <span class="n">phi</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>    <span class="c1"># Compute stress field</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>    <span class="n">sigma_xx</span><span class="p">,</span> <span class="n">sigma_yy</span><span class="p">,</span> <span class="n">sigma_xy</span> <span class="o">=</span> <span class="n">airy_to_stress</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">D2x</span><span class="p">,</span> <span class="n">D2y</span><span class="p">,</span> <span class="n">Dxy</span><span class="p">)</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>    <span class="n">stress_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">sigma_xx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">),</span> <span class="n">sigma_yy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">),</span> <span class="n">sigma_xy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>    <span class="c1"># Apply mask</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>    <span class="n">stress_field</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>    <span class="k">return</span> <span class="n">phi</span><span class="p">,</span> <span class="n">stress_field</span><span class="p">,</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="photoelastimetry.solver.equilibrium_solver.recover_stress_field_global_iterative" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">recover_stress_field_global_iterative</span><span class="p">(</span><span class="n">image_stack</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="n">C_values</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">S_i_hat</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">lambda_smooth</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">,</span> <span class="n">n_iterations</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">local_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#photoelastimetry.solver.equilibrium_solver.recover_stress_field_global_iterative" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Iterative global solver with alternating optimization strategy.</p>
<p>This approach alternates between:
1. Fixing the stress field and optimizing Airy function (enforcing equilibrium)
2. Fixing Airy function and locally refining to fit data better</p>
<p>This can be more robust than direct global optimization for difficult problems.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image_stack</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Image stack [H, W, 3, 4] with RGB channels and 4 polarization angles.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>wavelengths</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Wavelengths for RGB channels (m).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>C_values</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stress-optic coefficients for RGB channels (1/Pa).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nu</code>
            </td>
            <td>
                  <code><span title="float">float</span> or <span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solid fraction (use 1.0 for solid samples).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>L</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sample thickness (m).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>S_i_hat</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Incoming normalized Stokes vector [S1_hat, S2_hat, S3_hat].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Boolean mask indicating valid pixels [H, W].</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dx</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Grid spacing (default: 1.0).</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dy</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Grid spacing (default: 1.0).</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lambda_smooth</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Regularization weight (default: 1e-6).</p>
              </div>
            </td>
            <td>
                  <code>1e-06</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_iterations</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of alternating iterations (default: 5).</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>local_init</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialize with local solver (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print progress (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>phi</code></td>            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Airy stress function [H, W].</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>stress_field</code></td>            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stress components [H, W, 3] = [σ_xx, σ_yy, σ_xy].</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>residuals</code></td>            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Residual at each iteration.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>photoelastimetry/solver/equilibrium_solver.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-474" name="__codelineno-0-474"></a><span class="k">def</span><span class="w"> </span><span class="nf">recover_stress_field_global_iterative</span><span class="p">(</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>    <span class="n">image_stack</span><span class="p">,</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>    <span class="n">wavelengths</span><span class="p">,</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>    <span class="n">C_values</span><span class="p">,</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>    <span class="n">nu</span><span class="p">,</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>    <span class="n">L</span><span class="p">,</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>    <span class="n">S_i_hat</span><span class="p">,</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>    <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>    <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>    <span class="n">dy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>    <span class="n">lambda_smooth</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>    <span class="n">n_iterations</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>    <span class="n">local_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a><span class="p">):</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a><span class="sd">    Iterative global solver with alternating optimization strategy.</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a><span class="sd">    This approach alternates between:</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a><span class="sd">    1. Fixing the stress field and optimizing Airy function (enforcing equilibrium)</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a><span class="sd">    2. Fixing Airy function and locally refining to fit data better</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a><span class="sd">    This can be more robust than direct global optimization for difficult problems.</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a><span class="sd">    image_stack : ndarray</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a><span class="sd">        Image stack [H, W, 3, 4] with RGB channels and 4 polarization angles.</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a><span class="sd">    wavelengths : array-like</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a><span class="sd">        Wavelengths for RGB channels (m).</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a><span class="sd">    C_values : array-like</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a><span class="sd">        Stress-optic coefficients for RGB channels (1/Pa).</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a><span class="sd">    nu : float or ndarray</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a><span class="sd">        Solid fraction (use 1.0 for solid samples).</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a><span class="sd">    L : float</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a><span class="sd">        Sample thickness (m).</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a><span class="sd">    S_i_hat : array-like</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a><span class="sd">        Incoming normalized Stokes vector [S1_hat, S2_hat, S3_hat].</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a><span class="sd">    mask : ndarray, optional</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a><span class="sd">        Boolean mask indicating valid pixels [H, W].</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a><span class="sd">    dx, dy : float, optional</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a><span class="sd">        Grid spacing (default: 1.0).</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a><span class="sd">    lambda_smooth : float, optional</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a><span class="sd">        Regularization weight (default: 1e-6).</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a><span class="sd">    n_iterations : int, optional</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a><span class="sd">        Number of alternating iterations (default: 5).</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a><span class="sd">    local_init : bool, optional</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a><span class="sd">        Initialize with local solver (default: True).</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a><span class="sd">    verbose : bool, optional</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a><span class="sd">        Print progress (default: True).</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a><span class="sd">    -------</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a><span class="sd">    phi : ndarray</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a><span class="sd">        Airy stress function [H, W].</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a><span class="sd">    stress_field : ndarray</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a><span class="sd">        Stress components [H, W, 3] = [σ_xx, σ_yy, σ_xy].</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a><span class="sd">    residuals : list</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a><span class="sd">        Residual at each iteration.</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>    <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">image_stack</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>    <span class="c1"># Build operators</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>    <span class="n">D2x</span><span class="p">,</span> <span class="n">D2y</span><span class="p">,</span> <span class="n">Dxy</span><span class="p">,</span> <span class="n">L_op</span> <span class="o">=</span> <span class="n">build_finite_difference_operators</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>    <span class="c1"># Initialize with local solver</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>    <span class="k">if</span> <span class="n">local_init</span><span class="p">:</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing with local solver...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">photoelastimetry.solver.stokes_solver</span><span class="w"> </span><span class="kn">import</span> <span class="n">recover_stress_map</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>        <span class="n">stress_field</span> <span class="o">=</span> <span class="n">recover_stress_map</span><span class="p">(</span><span class="n">image_stack</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="n">C_values</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">S_i_hat</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>        <span class="n">stress_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>    <span class="n">residuals</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iterations</span><span class="p">):</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_iterations</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>        <span class="c1"># Step 1: Fit Airy function to current stress field</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fitting Airy function to stress field...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>        <span class="n">sigma_xx_flat</span> <span class="o">=</span> <span class="n">stress_field</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>        <span class="n">sigma_yy_flat</span> <span class="o">=</span> <span class="n">stress_field</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>        <span class="n">sigma_xy_flat</span> <span class="o">=</span> <span class="n">stress_field</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>        <span class="c1"># Set up least squares problem: minimize ||A φ - b||² + λ ||L φ||²</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>        <span class="c1"># where A combines D2y (for σ_xx), D2x (for σ_yy), -Dxy (for σ_xy)</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">vstack</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>        <span class="c1"># Weight matrix for valid pixels</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>        <span class="n">W_diag</span> <span class="o">=</span> <span class="n">diags</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>        <span class="n">A</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">(</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>            <span class="p">[</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>                <span class="n">W_diag</span> <span class="o">@</span> <span class="n">D2y</span><span class="p">,</span>  <span class="c1"># σ_xx = ∂²φ/∂y²</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>                <span class="n">W_diag</span> <span class="o">@</span> <span class="n">D2x</span><span class="p">,</span>  <span class="c1"># σ_yy = ∂²φ/∂x²</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>                <span class="o">-</span><span class="n">W_diag</span> <span class="o">@</span> <span class="n">Dxy</span><span class="p">,</span>  <span class="c1"># σ_xy = -∂²φ/∂x∂y</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>            <span class="p">]</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>        <span class="p">)</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>            <span class="p">[</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>                <span class="n">w</span> <span class="o">*</span> <span class="n">sigma_xx_flat</span><span class="p">,</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>                <span class="n">w</span> <span class="o">*</span> <span class="n">sigma_yy_flat</span><span class="p">,</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>                <span class="n">w</span> <span class="o">*</span> <span class="n">sigma_xy_flat</span><span class="p">,</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>            <span class="p">]</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>        <span class="p">)</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>        <span class="c1"># Solve regularized least squares</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>        <span class="n">AtA</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">A</span> <span class="o">+</span> <span class="n">lambda_smooth</span> <span class="o">*</span> <span class="n">L_op</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">L_op</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>        <span class="n">Atb</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">b</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>            <span class="n">phi_flat</span> <span class="o">=</span> <span class="n">spsolve</span><span class="p">(</span><span class="n">AtA</span><span class="p">,</span> <span class="n">Atb</span><span class="p">)</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>            <span class="n">phi</span> <span class="o">=</span> <span class="n">phi_flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Sparse solve failed, using previous phi&quot;</span><span class="p">)</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>            <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">))</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>        <span class="c1"># Step 2: Update stress field from Airy function</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing stresses from Airy function...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>        <span class="n">sigma_xx</span><span class="p">,</span> <span class="n">sigma_yy</span><span class="p">,</span> <span class="n">sigma_xy</span> <span class="o">=</span> <span class="n">airy_to_stress</span><span class="p">(</span><span class="n">phi_flat</span><span class="p">,</span> <span class="n">D2x</span><span class="p">,</span> <span class="n">D2y</span><span class="p">,</span> <span class="n">Dxy</span><span class="p">)</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>        <span class="n">stress_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>            <span class="p">[</span><span class="n">sigma_xx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">),</span> <span class="n">sigma_yy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">),</span> <span class="n">sigma_xy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>        <span class="p">)</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>        <span class="c1"># Step 3: Refine with local optimization where needed</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>        <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="n">n_iterations</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Skip on last iteration</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refining with local optimization...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>            <span class="c1"># Only refine pixels with high residuals</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>            <span class="n">n_refined</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">H</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Local refinement&quot;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">):</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">W</span><span class="p">):</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]:</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>                        <span class="k">continue</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>                    <span class="c1"># Get measured Stokes</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>                    <span class="n">S_m_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>                    <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>                        <span class="n">I</span> <span class="o">=</span> <span class="n">image_stack</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>                            <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>                            <span class="k">break</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>                        <span class="n">S0</span><span class="p">,</span> <span class="n">S1</span><span class="p">,</span> <span class="n">S2</span> <span class="o">=</span> <span class="n">stokes_solver</span><span class="o">.</span><span class="n">compute_stokes_components</span><span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>                        <span class="n">S1_hat</span><span class="p">,</span> <span class="n">S2_hat</span> <span class="o">=</span> <span class="n">stokes_solver</span><span class="o">.</span><span class="n">compute_normalized_stokes</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">S1</span><span class="p">,</span> <span class="n">S2</span><span class="p">)</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>                        <span class="n">S_m_hat</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">S1_hat</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>                        <span class="n">S_m_hat</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S2_hat</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>                        <span class="k">continue</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>                    <span class="c1"># Local refinement with current stress as initial guess</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>                    <span class="n">nu_pixel</span> <span class="o">=</span> <span class="n">nu</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span> <span class="k">else</span> <span class="n">nu</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>                    <span class="n">initial_guess</span> <span class="o">=</span> <span class="n">stress_field</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>                    <span class="n">stress_refined</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="n">stokes_solver</span><span class="o">.</span><span class="n">recover_stress_tensor</span><span class="p">(</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>                        <span class="n">S_m_hat</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="n">C_values</span><span class="p">,</span> <span class="n">nu_pixel</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">S_i_hat</span><span class="p">,</span> <span class="n">initial_guess</span><span class="o">=</span><span class="n">initial_guess</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>                    <span class="p">)</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>                        <span class="n">stress_field</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stress_refined</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>                        <span class="n">n_refined</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Refined </span><span class="si">{</span><span class="n">n_refined</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>        <span class="c1"># Compute residual</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>        <span class="n">residual</span> <span class="o">=</span> <span class="n">compute_global_residual</span><span class="p">(</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>            <span class="n">phi_flat</span><span class="p">,</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>            <span class="n">image_stack</span><span class="p">,</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>            <span class="n">wavelengths</span><span class="p">,</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>            <span class="n">C_values</span><span class="p">,</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>            <span class="n">nu</span><span class="p">,</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>            <span class="n">L</span><span class="p">,</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>            <span class="n">S_i_hat</span><span class="p">,</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>            <span class="n">D2x</span><span class="p">,</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>            <span class="n">D2y</span><span class="p">,</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>            <span class="n">Dxy</span><span class="p">,</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>            <span class="n">mask</span><span class="p">,</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>            <span class="n">lambda_smooth</span><span class="p">,</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>            <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>        <span class="p">)</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>        <span class="n">residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Residual: </span><span class="si">{</span><span class="n">residual</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>    <span class="c1"># Apply mask</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>    <span class="n">stress_field</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>    <span class="k">return</span> <span class="n">phi</span><span class="p">,</span> <span class="n">stress_field</span><span class="p">,</span> <span class="n">residuals</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="photoelastimetry.solver.equilibrium_solver.compare_local_vs_global" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">compare_local_vs_global</span><span class="p">(</span><span class="n">image_stack</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="n">C_values</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">S_i_hat</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lambda_smooth</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">,</span> <span class="n">true_stress</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#photoelastimetry.solver.equilibrium_solver.compare_local_vs_global" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Compare local and global inversion methods.</p>
<p>This utility function runs both methods and provides comparison metrics.
Useful for validation and parameter tuning.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image_stack</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Image stack [H, W, 3, 4].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>wavelengths</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Wavelengths for RGB channels (m).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>C_values</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stress-optic coefficients (1/Pa).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nu</code>
            </td>
            <td>
                  <code><span title="float">float</span> or <span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solid fraction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>L</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sample thickness (m).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>S_i_hat</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Incoming Stokes vector.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Valid pixel mask.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lambda_smooth</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Regularization for global method.</p>
              </div>
            </td>
            <td>
                  <code>1e-06</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>true_stress</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ground truth stress field [H, W, 3] for validation.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>results</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
- 'local_stress': Local solver result
- 'global_stress': Global solver result
- 'global_phi': Airy function
- 'local_residual': Data misfit for local
- 'global_residual': Data misfit for global
- 'local_smoothness': Smoothness metric for local
- 'global_smoothness': Smoothness metric for global
- 'local_error': Error vs truth (if provided)
- 'global_error': Error vs truth (if provided)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>photoelastimetry/solver/equilibrium_solver.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span>
<span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-681" name="__codelineno-0-681"></a><span class="k">def</span><span class="w"> </span><span class="nf">compare_local_vs_global</span><span class="p">(</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>    <span class="n">image_stack</span><span class="p">,</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>    <span class="n">wavelengths</span><span class="p">,</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>    <span class="n">C_values</span><span class="p">,</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>    <span class="n">nu</span><span class="p">,</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>    <span class="n">L</span><span class="p">,</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>    <span class="n">S_i_hat</span><span class="p">,</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>    <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>    <span class="n">lambda_smooth</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>    <span class="n">true_stress</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a><span class="p">):</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a><span class="sd">    Compare local and global inversion methods.</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a><span class="sd">    This utility function runs both methods and provides comparison metrics.</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a><span class="sd">    Useful for validation and parameter tuning.</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a><span class="sd">    image_stack : ndarray</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a><span class="sd">        Image stack [H, W, 3, 4].</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a><span class="sd">    wavelengths : array-like</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a><span class="sd">        Wavelengths for RGB channels (m).</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a><span class="sd">    C_values : array-like</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a><span class="sd">        Stress-optic coefficients (1/Pa).</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a><span class="sd">    nu : float or ndarray</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a><span class="sd">        Solid fraction.</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a><span class="sd">    L : float</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a><span class="sd">        Sample thickness (m).</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a><span class="sd">    S_i_hat : array-like</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a><span class="sd">        Incoming Stokes vector.</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a><span class="sd">    mask : ndarray, optional</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a><span class="sd">        Valid pixel mask.</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a><span class="sd">    lambda_smooth : float, optional</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a><span class="sd">        Regularization for global method.</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a><span class="sd">    true_stress : ndarray, optional</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a><span class="sd">        Ground truth stress field [H, W, 3] for validation.</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a><span class="sd">    -------</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a><span class="sd">    results : dict</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a><span class="sd">        - &#39;local_stress&#39;: Local solver result</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a><span class="sd">        - &#39;global_stress&#39;: Global solver result</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a><span class="sd">        - &#39;global_phi&#39;: Airy function</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a><span class="sd">        - &#39;local_residual&#39;: Data misfit for local</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a><span class="sd">        - &#39;global_residual&#39;: Data misfit for global</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a><span class="sd">        - &#39;local_smoothness&#39;: Smoothness metric for local</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a><span class="sd">        - &#39;global_smoothness&#39;: Smoothness metric for global</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a><span class="sd">        - &#39;local_error&#39;: Error vs truth (if provided)</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a><span class="sd">        - &#39;global_error&#39;: Error vs truth (if provided)</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">photoelastimetry.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">recover_stress_map</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Running Local Solver ===&quot;</span><span class="p">)</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>    <span class="n">stress_local</span> <span class="o">=</span> <span class="n">recover_stress_map</span><span class="p">(</span><span class="n">image_stack</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="n">C_values</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">S_i_hat</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Running Global Solver ===&quot;</span><span class="p">)</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>    <span class="n">phi</span><span class="p">,</span> <span class="n">stress_global</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">recover_stress_field_global</span><span class="p">(</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>        <span class="n">image_stack</span><span class="p">,</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>        <span class="n">wavelengths</span><span class="p">,</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>        <span class="n">C_values</span><span class="p">,</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>        <span class="n">nu</span><span class="p">,</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>        <span class="n">L</span><span class="p">,</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>        <span class="n">S_i_hat</span><span class="p">,</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>        <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>        <span class="n">lambda_smooth</span><span class="o">=</span><span class="n">lambda_smooth</span><span class="p">,</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>        <span class="n">initial_phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>        <span class="n">maxiter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>    <span class="p">)</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>    <span class="c1"># Compute metrics</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>    <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">image_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>    <span class="n">D2x</span><span class="p">,</span> <span class="n">D2y</span><span class="p">,</span> <span class="n">Dxy</span><span class="p">,</span> <span class="n">L_op</span> <span class="o">=</span> <span class="n">build_finite_difference_operators</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>    <span class="c1"># Data residuals</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>    <span class="n">local_residual</span> <span class="o">=</span> <span class="n">compute_global_residual</span><span class="p">(</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>        <span class="n">stress_local</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>        <span class="n">image_stack</span><span class="p">,</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>        <span class="n">wavelengths</span><span class="p">,</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>        <span class="n">C_values</span><span class="p">,</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>        <span class="n">nu</span><span class="p">,</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>        <span class="n">L</span><span class="p">,</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>        <span class="n">S_i_hat</span><span class="p">,</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>        <span class="n">D2x</span><span class="p">,</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>        <span class="n">D2y</span><span class="p">,</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>        <span class="n">Dxy</span><span class="p">,</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>        <span class="n">mask</span><span class="p">,</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>        <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>        <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>    <span class="p">)</span>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>    <span class="n">global_residual</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fun</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a>    <span class="c1"># Smoothness (total variation)</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_smoothness</span><span class="p">(</span><span class="n">stress</span><span class="p">):</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>        <span class="n">grad_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">stress</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>        <span class="n">grad_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">stress</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">grad_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">grad_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>    <span class="n">local_smoothness</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">compute_smoothness</span><span class="p">(</span><span class="n">stress_local</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a>    <span class="n">global_smoothness</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">compute_smoothness</span><span class="p">(</span><span class="n">stress_global</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>        <span class="s2">&quot;local_stress&quot;</span><span class="p">:</span> <span class="n">stress_local</span><span class="p">,</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>        <span class="s2">&quot;global_stress&quot;</span><span class="p">:</span> <span class="n">stress_global</span><span class="p">,</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>        <span class="s2">&quot;global_phi&quot;</span><span class="p">:</span> <span class="n">phi</span><span class="p">,</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>        <span class="s2">&quot;local_residual&quot;</span><span class="p">:</span> <span class="n">local_residual</span><span class="p">,</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>        <span class="s2">&quot;global_residual&quot;</span><span class="p">:</span> <span class="n">global_residual</span><span class="p">,</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>        <span class="s2">&quot;local_smoothness&quot;</span><span class="p">:</span> <span class="n">local_smoothness</span><span class="p">,</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>        <span class="s2">&quot;global_smoothness&quot;</span><span class="p">:</span> <span class="n">global_smoothness</span><span class="p">,</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>    <span class="p">}</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>    <span class="c1"># Error vs ground truth</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>    <span class="k">if</span> <span class="n">true_stress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>        <span class="n">local_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">((</span><span class="n">stress_local</span> <span class="o">-</span> <span class="n">true_stress</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>        <span class="n">global_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">((</span><span class="n">stress_global</span> <span class="o">-</span> <span class="n">true_stress</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;local_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_error</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;global_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_error</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Comparison Results ===&quot;</span><span class="p">)</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Local RMSE vs truth: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">local_error</span><span class="p">)</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Global RMSE vs truth: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">global_error</span><span class="p">)</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Local data residual: </span><span class="si">{</span><span class="n">local_residual</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Global data residual: </span><span class="si">{</span><span class="n">global_residual</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Local smoothness: </span><span class="si">{</span><span class="n">local_smoothness</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Global smoothness: </span><span class="si">{</span><span class="n">global_smoothness</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a>    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>